generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model administrador {
  id            Int             @id @default(autoincrement())
  usuario_id    Int             @unique
  usuario       usuario         @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  orden_trabajo orden_trabajo[]
}

model categoria {
  id       Int        @id @default(autoincrement())
  nombre   String     @db.VarChar(80)
  servicio servicio[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model cliente {
  ci        Int        @id
  nombre    String
  telefono  String
  direccion String
  factura   factura[]
  proforma  proforma[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model comision {
  id            Int            @id @default(autoincrement())
  orden_id      BigInt?        @unique
  monto         Decimal        @db.Decimal(12, 2)
  estado_pago   estado_pago    @default(PENDIENTE)
  fecha_pago    DateTime?      @default(dbgenerated("CURRENT_DATE")) @db.Date
  orden_trabajo orden_trabajo? @relation(fields: [orden_id], references: [id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model detalle_diagnostico {
  id             BigInt      @default(autoincrement())
  diagnostico_id BigInt
  descripcion    String
  diagnostico    diagnostico @relation(fields: [diagnostico_id], references: [nro], onDelete: Cascade, onUpdate: NoAction)

  @@id([id, diagnostico_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model detalle_proforma {
  id          BigInt    @default(autoincrement())
  proforma_id BigInt
  servicio_id Int?
  descripcion String    @db.VarChar(250)
  cantidad    Decimal   @db.Decimal(10, 2)
  precio_unit Decimal   @db.Decimal(12, 2)
  subtotal    Decimal?  @db.Decimal(12, 2)
  proforma    proforma  @relation(fields: [proforma_id], references: [id], onDelete: Cascade)
  servicio    servicio? @relation(fields: [servicio_id], references: [id], onDelete: Restrict)

  @@id([id, proforma_id])
}

model diagnostico {
  nro                 BigInt                @id @default(autoincrement())
  fecha               DateTime              @db.Date
  hora                DateTime              @db.Time(6)
  placa_moto          String                @db.VarChar(10)
  empleado_ci         Int
  detalle_diagnostico detalle_diagnostico[]
  empleado            empleado              @relation(fields: [empleado_ci], references: [ci])
  moto                moto                  @relation(fields: [placa_moto], references: [placa])
  proforma            proforma?

  @@unique([placa_moto, fecha, hora], map: "uq_diag_moto_momento")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model empleado {
  ci               Int                @id
  nombre           String             @db.VarChar(120)
  fechanac         DateTime           @db.Date
  direccion        String             @db.VarChar(200)
  telefono         Int
  diagnostico      diagnostico[]
  horario_empleado horario_empleado[]
  orden_trabajo    orden_trabajo[]
  usuario          usuario?
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model factura {
  id         BigInt   @id @default(autoincrement())
  monto      Decimal  @db.Decimal(12, 2)
  fecha      DateTime @default(dbgenerated("CURRENT_DATE")) @db.Date
  cliente_ci Int
  cliente    cliente  @relation(fields: [cliente_ci], references: [ci])
}

model herramienta {
  id                     Int                      @id @default(autoincrement())
  nombre                 String                   @db.VarChar(120)
  descripcion            String?                  @db.VarChar(250)
  marca_id               Int
  marca_herramienta      marca_herramienta        @relation(fields: [marca_id], references: [id])
  movimiento_herramienta movimiento_herramienta[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model horario {
  id               Int                @id @default(autoincrement())
  hora_inicio      DateTime           @db.Time(6)
  hora_fin         DateTime           @db.Time(6)
  horario_empleado horario_empleado[]
}

model horario_empleado {
  empleado_ci Int
  horario_id  Int
  fecha       DateTime @db.Date
  empleado    empleado @relation(fields: [empleado_ci], references: [ci], onDelete: Cascade)
  horario     horario  @relation(fields: [horario_id], references: [id])

  @@id([empleado_ci, horario_id])
}

model marca_herramienta {
  id          Int           @id @default(autoincrement())
  nombre      String        @db.VarChar(100)
  herramienta herramienta[]
}

model marca_moto {
  id     Int    @id @default(autoincrement())
  nombre String
  moto   moto[]
}

model moto {
  placa       String        @id @db.VarChar(10)
  modelo      String
  year        Int           @db.SmallInt
  chasis      String?       @unique
  marca_id    Int
  diagnostico diagnostico[]
  marca_moto  marca_moto    @relation(fields: [marca_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model movimiento_herramienta {
  herramienta_id   Int
  orden_trabajo_id BigInt
  fecha            DateTime      @db.Date
  cantidad         Int
  herramienta      herramienta   @relation(fields: [herramienta_id], references: [id])
  orden_trabajo    orden_trabajo @relation(fields: [orden_trabajo_id], references: [id], onDelete: Cascade)

  @@id([orden_trabajo_id, herramienta_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model orden_trabajo {
  id                     BigInt                   @id @default(autoincrement())
  fecha_inicio           DateTime                 @db.Date
  fecha_fin              DateTime?                @db.Date
  estado                 estado_orden             @default(ABIERTA)
  empleado_ci            Int
  administrador_id       Int?
  servicio_id            Int
  comision               comision?
  movimiento_herramienta movimiento_herramienta[]
  administrador          administrador?           @relation(fields: [administrador_id], references: [id])
  empleado               empleado                 @relation(fields: [empleado_ci], references: [ci])
  servicio               servicio                 @relation(fields: [servicio_id], references: [id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model proforma {
  id                BigInt              @id @default(autoincrement())
  fecha             DateTime            @db.Date
  estado            estado_proforma     @default(PENDIENTE)
  total             Decimal             @default(0) @db.Decimal(12, 2)
  cliente_ci        Int
  diagnostico_id    BigInt?             @unique
  detalle_proforma  detalle_proforma[]
  cliente           cliente             @relation(fields: [cliente_ci], references: [ci])
  diagnostico       diagnostico?        @relation(fields: [diagnostico_id], references: [nro])
  proforma_repuesto proforma_repuesto[]
}

model proforma_repuesto {
  id          Int      @id @default(autoincrement())
  nombre      String   @db.VarChar(120)
  proforma_id BigInt
  proforma    proforma @relation(fields: [proforma_id], references: [id])
}

model servicio {
  id               Int                @id @default(autoincrement())
  descripcion      String             @db.VarChar(200)
  categoria_id     Int
  detalle_proforma detalle_proforma[]
  orden_trabajo    orden_trabajo[]
  categoria        categoria          @relation(fields: [categoria_id], references: [id])
}

model usuario {
  id            Int            @id @default(autoincrement())
  empleado_ci   Int            @unique
  usuario       String         @unique @db.VarChar(50)
  contrasena    String         @db.VarChar(200)
  email         String?        @unique @db.VarChar(150)
  administrador administrador?
  empleado      empleado       @relation(fields: [empleado_ci], references: [ci], onDelete: Cascade)
  bitacora      bitacora[]
}

model bitacora {
  id_bitacora BigInt   @id @default(autoincrement())
  usuario_id  Int?
  descripcion String?
  fecha_hora  DateTime @default(now()) @db.Timestamptz(6)
  ip_origen   String?  @db.VarChar(45)
  usuario     usuario? @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

enum estado_orden {
  ABIERTA
  EN_PROCESO
  CERRADA
  ANULADA
}

enum estado_pago {
  PENDIENTE
  PAGADA
  RECHAZADA
}

enum estado_proforma {
  PENDIENTE
  APROBADA
  ANULADA
}
