// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Rol {
  id          Int           @id @default(autoincrement()) @map("ID")
  nombre      String        @db.VarChar(100) @map("NOMBRE")
  usuarios    Usuario[]
  permisos    RolPermiso[]

  @@map("ROL")
}

model Permiso {
  id       Int           @id @default(autoincrement()) @map("ID")
  nombre   String        @db.VarChar(100) @map("NOMBRE")
  roles    RolPermiso[]

  @@map("PERMISO")
}

model RolPermiso {
  idPermiso  Int      @map("ID_PERMISO")
  idRol      Int      @map("ID_ROL")
  permiso    Permiso  @relation(fields: [idPermiso], references: [id], onDelete: Cascade, onUpdate: Cascade)
  rol        Rol      @relation(fields: [idRol], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([idPermiso, idRol])
  @@map("ROL_PERMISO")
}

model Usuario {
  id       Int        @id @default(autoincrement()) @map("ID")
  username String     @unique @db.VarChar(30) @map("USERNAME")
  password String     @db.VarChar(255) @map("PASSWORD")
  email    String     @unique @db.VarChar(30) @map("EMAIL")
  idRol    Int?       @map("ID_ROL")
  rol      Rol?       @relation(fields: [idRol], references: [id], onDelete: Cascade, onUpdate: Cascade)
  empleado Empleado?

  @@map("USUARIO")
}

model Empleado {
  ci            Int            @id @map("CI")
  idUsuario     Int?           @unique @map("ID_USUARIO")
  nombre        String         @db.VarChar(15) @map("NOMBRE")
  apellidos     String         @db.VarChar(50) @map("APELLIDOS")
  direccion     String         @db.VarChar(70) @map("DIRECCION")
  fechaNac      DateTime       @db.Date @map("FECHANAC")
  telefono      String         @db.VarChar(10) @map("TELEFONO")
  usuario       Usuario?       @relation(fields: [idUsuario], references: [id], onDelete: SetNull)
  diagnosticos  Diagnostico[]

  @@map("EMPLEADO")
}

model MarcaMoto {
  id      Int     @id @default(autoincrement()) @map("ID")
  nombre  String  @map("NOMBRE")
  motos   Moto[]

  @@map("MARCA_MOTO")
}

model Moto {
  placa         String         @id @db.VarChar(10) @map("PLACA")
  modelo        String         @map("MODELO")
  anio          Int            @db.SmallInt @map("AÃ‘O")
  chasis        String?        @unique @map("CHASIS")
  marcaId       Int            @map("MARCA_ID")
  marca         MarcaMoto      @relation(fields: [marcaId], references: [id])
  diagnosticos  Diagnostico[]

  @@map("MOTO")
}

model Diagnostico {
  nro         BigInt                 @id @default(autoincrement()) @map("NRO")
  fecha       DateTime               @db.Date @map("FECHA")
  hora        DateTime               @db.Time @map("HORA")
  placaMoto   String                 @db.VarChar(10) @map("PLACA_MOTO")
  empleadoCi  Int                    @map("EMPLEADO_CI")
  moto        Moto                   @relation(fields: [placaMoto], references: [placa], onUpdate: Cascade, onDelete: Restrict)
  empleado    Empleado               @relation(fields: [empleadoCi], references: [ci], onUpdate: Cascade, onDelete: Restrict)
  detalles    DetalleDiagnostico[]

  @@unique([placaMoto, fecha, hora], name: "UQ_DIAG_MOTO_MOMENTO")
  @@map("DIAGNOSTICO")
}

model DetalleDiagnostico {
  id             BigInt       @default(autoincrement()) @map("ID")
  diagnosticoId  BigInt       @map("DIAGNOSTICO_ID")
  descripcion    String       @map("DESCRIPCION")
  diagnostico    Diagnostico  @relation(fields: [diagnosticoId], references: [nro], onDelete: Cascade)

  @@id([id, diagnosticoId])
  @@map("DETALLE_DIAGNOSTICO")
}
